{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Night Pillow</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <script src="{% static 'js/script.js' %}"></script>
</head>
<body>
    <div class="top-bar">
        <h1>Night Pillow</h1>
    </div>
    <div class="container">
        <div class="sidebar">
            <a href="{% url 'alarms:home' %}" onclick="showPage('home')">Home</a>
            <a href="{% url 'alarms:sleep_calculator' %}" onclick="showPage('sleep_calculator')">Sleep Time Calculator</a> 
            <a href="{% url 'alarms:sleep_data' %}" onclick="showPage('sleep_data')">Sleep Data</a>
            <a href="{% url 'alarms:reminders' %}" onclick="showPage('reminders')">Reminders</a>
        </div>
        <div class="main">
            <div id="home" class="page">
                <h2>Time Slept Today</h2>
                <div class="time-box">
                 <label>Time Slept: <input type="time" id="sleep_time"></label>
                </div>
                <div class="time-box">
                    <label>Wake Up Time: <input type="time" id="wakeUpTime"></label>
                </div>
                <div class="rating">
                    <input type="radio" id="star5" name="rating" value="5"><label for="star5">★</label>
                    <input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label>
                    <input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label>
                    <input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label>
                    <input type="radio" id="star1" name="rating" value="1"><label for="star1">★</label>
                </div>
                <div>
                    <button onclick="saveSleepData()">Save Sleep Data</button>
        
                <script>
                    function saveSleepData() {
                        const sleepTime = document.getElementById('sleep_time').value;
                        const wakeUpTime = document.getElementById('wakeUpTime').value;
                        const rating = document.querySelector('input[name="rating"]:checked').value;

                        console.log("Sleep Time:", sleep_time);
                        console.log("Wake Up Time:", wakeUpTime);
                        console.log("Rating:", rating);

                        // Add these lines
                        console.log("Data to send:", { sleepTime: sleepTime, wakeUpTime: wakeUpTime, rating: rating });

                        if (!sleepTime || !wakeUpTime || !rating) {
                            alert("Please fill in all fields.");
                            return;
                        }

                        if (!/^\d{2}:\d{2}$/.test(sleepTime) || !/^\d{2}:\d{2}$/.test(wakeUpTime)) {
                            alert("Please enter time in HH:MM format.");
                            return;
                        }

                        const ratingValue = rating.value;

                        fetch("/save-sleep-data/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": getCookie("csrftoken"),
                            },
                            body: JSON.stringify({ sleepTime: sleepTime, wakeUpTime: wakeUpTime, rating: rating })
                        })

                        .then(response => {
                            console.log("Response:" , response);
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.message) {
                                alert(data.message);
                            } else if (data.error) {
                                alert(data.error);
                            }
                        })
                        .then(data => {
                            console.log("server response:", data);
                            if (data.message) {
                                alert("Sleep data saved successfully!");
                            } else if (data.error) {
                                alert(data.error);
                            }
                        })
                        .catch(error => {
                            console.error("Error saving sleep data:", error);
                            alert("An error occurred while saving sleep data. Please check the console.");
                        });
                    }
                
                    // Function to get CSRF token
                    function getCookie(name) {
                        let cookieValue = null;
                        if (document.cookie && document.cookie !== "") {
                            let cookies = document.cookie.split(";");
                            for (let i = 0; i < cookies.length; i++) {
                                let cookie = cookies[i].trim();
                                if (cookie.startsWith(name + "=")) {
                                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                    break;
                                }
                            }
                        }
                        return cookieValue;
                    }
                </script> 
                </div>
            </div>   
            <div id="calculator" class="page" style="display: none;">
                <h2>Sleep Time Calculator</h2>
                <label>Enter your wake-up time: <input type="time" id="wakeUpTime"></label>
                <button onclick="calculateSleepTimes()">Calculate Best Sleep Time</button>
                <div id="recommendations" class="recommendations"></div>
            </div>
            <div id="data" class="page" style="display: none;">
                <h2>Sleep Data</h2>
                <p>View your sleep history and trends here.</p>
            </div>
            <div id="alarms" class="page" style="display: none;">
                <h2>Alarms</h2>
                <label>Set Alarm Time: <input type="time"></label>
                <button>Set Alarm</button>
            </div>
        </div>
        <div class="right-sidebar">
            <h2>Active Alarms</h2>
            <ul class="alarm-list">
                <li class="alarm-item">6:30 AM</li>
                <li class="alarm-item">7:00 AM</li>
                <li class="alarm-item">7:30 AM</li>
            </ul>
        </div>
    </div>
</body>
</html>
